{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Range Slider Example</title>

<style>
.slider-container {
    display: inline-block;
    margin: 5px;
}

.slider {
    -webkit-appearance: none;
    width: 700px;
    height: 10px;
    border-radius: 5px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #000080;
    cursor: pointer;
}

.slider::-ha-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #000080;
    cursor: pointer;
}

button {
    display: inline-block;
    margin-left: 10px;
    vertical-align: middle;
}
</style>
</head>
<body>

<p> <span id="queryValueDisplay"></span> 을(를) <span id="minValueDisplay"></span>부터 "<span id="maxValueDisplay"></span>"까지 "<span id="sortValueDisplay"></span>" 방식으로 찾아본 결과입니다.</p>


<p id="error" style="color: red; display: none;">정확한 범위를 지정해 주세요!</p>

<div class="slider-container">
    <input type="range" min="0" max="3000000" value="0" class="slider" step="1000" id="minSlider">
    <p> 최솟값 : <span id="minValue"></span> </p>
</div>

<div class="slider-container">
    <input type="range" min="0" max="3000000" value="3000000" class="slider" step="1000" id="maxSlider">
    <p> 최댓값 : <span id="maxValue"></span> </p>
</div>

<div style="display: inline-block; padding-right: 130px;">
    <input type="checkbox" name="sort" value="latest" onclick="updateSortOption(this)"> 최신순
    <input type="checkbox" name="sort" value="popularity" onclick="updateSortOption(this)"> 인기순
    <input type="checkbox" name="sort" value="price_low" onclick="updateSortOption(this)"> 가격 낮은순
    <input type="checkbox" name="sort" value="price_high" onclick="updateSortOption(this)"> 가격 높은순

    <form id="searchForm" onsubmit="make_report(); return false;">
        <p><input type="submit" value="Submit"></p>
    </form>

</div>



<script>
    var query = get_url_parameter('query');
    var minSlider = document.getElementById("minSlider");
    var maxSlider = document.getElementById("maxSlider");
    var minOutput = document.getElementById("minValue");
    var maxOutput = document.getElementById("maxValue");
    var errorElement = document.getElementById("error");
    var min = 0;
    var max = 3000000;
    var sort = "latest"; 
    var page_point = 1;
    
    minOutput.innerHTML = addCommas(minSlider.value);
    maxOutput.innerHTML = addCommas(maxSlider.value);

    window.onload = function() {
        optionDisplay();
    };
    
    minSlider.oninput = function() {
      minOutput.innerHTML = addCommas(this.value);
      checkRange();
      updateMinOption();
    }
    
    maxSlider.oninput = function() {
      maxOutput.innerHTML = addCommas(this.value);
      checkRange();
      updateMaxOption()
      
    }
    
    function addCommas(value) {
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + '원';
    }
    
    function checkRange() {
      if (parseInt(minSlider.value) >= parseInt(maxSlider.value)) {
        errorElement.style.display = 'block';
      } else {
        errorElement.style.display = 'none';
      }
    }
    
    function make_report() {
        query = get_url_parameter('query');
        var newUrl = '/search/report?query=' + query + '&sort=' + sort + '&min=' + min + '&max=' + max + '&page=' + page_point;
        optionDisplay();
        window.location.href = newUrl; 
    }

    function get_url_parameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function updateSortOption(checkbox) {
      if (checkbox.checked) {
        sort = checkbox.value;

      } else {
        sort = 'latest';
      }
    }

    function updateMinOption() {
        min = minSlider.value
    }
    function updateMaxOption(checkbox) {
        max = maxSlider.value
      
    }

    function goToPage(page) 
    {   
        query = get_all_url_parameter('query');
        sort = get_all_url_parameter('sort');
        min = get_all_url_parameter('min');
        max = get_all_url_parameter('max');

        page_point = page;
        make_report();

    }
    
    

    function optionDisplay()
    {
        query = get_all_url_parameter('query');
        min = get_all_url_parameter('min');
        max = get_all_url_parameter('max')
        sort = get_all_url_parameter('sort');
    
        document.getElementById("queryValueDisplay").innerText = query;
        document.getElementById("minValueDisplay").innerText = addCommas(min);
        document.getElementById("maxValueDisplay").innerText = addCommas(max);
        document.getElementById("sortValueDisplay").innerText = sort;
    }

    function get_all_url_parameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

</script>




</body>




    

    
    <div class="container px-5 mx-auto mt-20" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; ">
        {% for product in page_obj %}
            <div style="border: 1px solid #ccc;">
                <img src="{{ product.Pd_IMG }}" style="width: 100%; height: auto;" alt="Product Image">
                <h6>{{ product.Pd_Name }}</h6>
                <a href="{{ product.Pd_URL }}"> 링크는 이쪽 !</a>
                <p>Market: {{ product.Pd_Market }}</p>
                <p>Category: {{ product.Pd_Category }}</p>
                <p>Price: {{ product.Pd_Price }} 원 </p>

                <!-- wishlist 추가사항 -->
                <form method="post" action="{% url 'accounts_app:add_to_wishlist' product.Pd_IndexNumber %}">
                    {% csrf_token %}
                    {{ form.as_p }}
                    {% if user.is_authenticated %}
                        <button type="submit">Add to Wishlist</button>
                    {% else %}
                        <p>Please <a href="{% url 'accounts_app:login' %}">login</a> to add to your wishlist.</p>
                    {% endif %}
                </form>

            </div>
        {% empty %}
            <p>No results found.</p>
        {% endfor %}
    </div>

    <div class="container mt-5">
        {% if page_obj.has_other_pages %}
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="#" onclick="goToPage({{ page_obj.previous_page_number }})">&#10094;</a>
        </li>
        {% endif %}

        {% for page in paginator.page_range %}
        {% if page_start_number <= page and page_end_number >= page %}
            {% if page == page_obj.number %}
            <li class="page-item active">
                <a class="page-link" href="#" onclick="goToPage({{ page }})">{{ page }}</a>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage({{ page }})">{{ page }}</a>
            </li>
            {% endif %}
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="#" onclick="goToPage({{ page_obj.next_page_number }})">&#10095;</a>
        </li>
        {% endif %}
    </ul>
{% endif %}

    


    </div>
{% endblock %}